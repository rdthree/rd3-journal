# rd3 journal 

## Project Overview

**rd3 journal** is a digital journaling platform built with [Eleventy (11ty)](https://www.11ty.dev/), designed to seamlessly integrate written entries with interactive JavaScript sketches using **p5.js**, **D3.js**, and **Three.js**. The setup allows for fluid navigation and instant sketch loading without page refreshes, leveraging **TypeScript** for enhanced development experience and type safety.

## Table of Contents

- [rd3 journal](#rd3-journal)
  - [Project Overview](#project-overview)
  - [Table of Contents](#table-of-contents)
  - [Project Structure](#project-structure)
  - [Key Configuration Files](#key-configuration-files)
    - [.eleventy.js](#eleventyjs)
      - [Explanation](#explanation)
    - [globals.d.ts](#globalsdts)
      - [p5.js Global Declaration](#p5js-global-declaration)
    - [main.css](#maincss)
      - [Explanation](#explanation-1)
    - [layout.njk](#layoutnjk)
      - [Explanation](#explanation-2)
    - [threejs-shared-module.js and .d.ts](#threejs-shared-modulejs-and-dts)
      - [threejs-shared-module.js](#threejs-shared-modulejs)
      - [threejs-shared-module.d.ts](#threejs-shared-moduledts)
  - [How to Use](#how-to-use)
    - [Creating a New Entry](#creating-a-new-entry)
    - [Embedding Sketches](#embedding-sketches)
    - [Writing p5.js Sketches in TypeScript](#writing-p5js-sketches-in-typescript)
      - [Example](#example)
    - [Writing D3.js Sketches](#writing-d3js-sketches)
      - [Example](#example-1)
    - [Writing Three.js Sketches](#writing-threejs-sketches)
      - [Example](#example-2)
  - [Build and Development](#build-and-development)
    - [Installing Dependencies](#installing-dependencies)
    - [Building the Project](#building-the-project)
    - [Development with Live Reloading](#development-with-live-reloading)
    - [Scripts in package.json](#scripts-in-packagejson)
    - [Scripts in `package.json`](#scripts-in-packagejson-1)
      - [`start`](#start)
      - [`build`](#build)
      - [`watch:ts`](#watchts)
      - [`eleventy:serve`](#eleventyserve)
  - [Troubleshooting](#troubleshooting)
  - [Remember](#remember)
  - [Additional Resources](#additional-resources)

## Project Structure

```
11thy-digital-journal/
├── src/
│   ├── entries/
│   │   ├── 240809-sticks-n-stones/
│   │   │   ├── sketch.md
│   │   │   ├── sketch_p5.js
│   │   │   ├── sketch_2_p5.js
│   │   │   └── sketch_3_p5.js
│   │   ├── 240812-p5.js-ts-sketches/
│   │   │   ├── sketch.md
│   │   │   ├── sketch_p5.ts
│   │   │   ├── sketch_p5_2.ts
│   │   │   └── sketch_p5_3.ts
│   │   └── 240818-test-p5js-d3-three/
│   │       ├── sketch.md
│   │       ├── p5jtest.js
│   │       ├── d3test.js
│   │       └── threetest.js
│   ├── _includes/
│   │   └── layout.njk
│   ├── styles/
│   │   └── main.css
│   ├── scripts/
│   │   └── threejs-shared-module.js
│   ├── types/
│   │   ├── globals.d.ts
│   │   └── threejs-shared-module.d.ts
│   ├── index.md
│   └── favicon.ico
├── _site/
├── .eleventy.js
├── tsconfig.json
├── package.json
└── README.md
```

- **src/**: Source files for the project.
  - **entries/**: Contains dated folders with your journal entries and associated sketches.
  - **_includes/**: Nunjucks templates, including the main `layout.njk`.
  - **styles/**: CSS files, including `main.css`.
  - **scripts/**: Shared JavaScript files, including `threejs-shared-module.js`.
  - **types/**: TypeScript declaration files, including `globals.d.ts` and `threejs-shared-module.d.ts`.
  - **index.md**: The homepage of your journal.
  - **favicon.ico**: The favicon for your site.
- **_site/**: The output directory generated by Eleventy.
- **.eleventy.js**: Eleventy configuration file.
- **tsconfig.json**: TypeScript configuration file.
- **package.json**: Project dependencies and scripts.
- **README.md**: The comprehensive guide you're reading.

## Key Configuration Files

### .eleventy.js

This file is the core of the Eleventy configuration. It orchestrates the build process, defines custom shortcodes, and configures various aspects of site generation.

**Note**: If you make changes to the `.eleventy.js` file, you'll need to restart the development server or rebuild the project for the changes to take effect. This is because `.eleventy.js` is a configuration file that's loaded when Eleventy starts up.

To apply changes in `.eleventy.js`:
1. Stop the current development server (if running)
2. Run `npm run build` to rebuild the project
3. Start the development server again with `npm run start`

This ensures that your new Eleventy configuration is properly applied to the project.


#### Explanation

- **Passthrough Copy**: Ensures that certain files and directories are copied to the output without modification.

  ```javascript
  eleventyConfig.addPassthroughCopy("src/styles");
  eleventyConfig.addPassthroughCopy("src/scripts");
  eleventyConfig.addPassthroughCopy("src/entries/**/*.js");
  eleventyConfig.addPassthroughCopy("src/favicon.ico");
  ```

- **Watch Targets**: Specifies additional files to watch for changes during development.

  ```javascript
  eleventyConfig.addWatchTarget("src/styles/");
  eleventyConfig.addWatchTarget("src/scripts/");
  eleventyConfig.addWatchTarget("src/entries/");
  ```

- **Global Data**: Computes default layout and title for each page.

  ```javascript
  eleventyConfig.addGlobalData("eleventyComputed", {
    layout: (data) => data.layout || "layout.njk",
    title: (data) => {
      if (data.title) return data.title;
      const filePathStem = data.page.filePathStem;
      const parts = filePathStem.split('/');
      const folderName = parts.length > 1 ? parts[parts.length - 2] : '';
      return folderName || 'Home';
    },
  });
  ```

- **Library Loading Function**: Dynamically loads external libraries like p5.js and D3.js.

  ```javascript
  function loadLibrary(library) {
    const libraries = {
      p5: {
        src: "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.10.0/p5.min.js",
        integrity: "sha512-lvddmeF7aHRJwdbJeYThWd5kWSjTrXBzCRF/jYROiHzmhMJ1dEXfGH5Q7ft0yhizXTopAETG03s5ajTflauijA==",
        crossorigin: "anonymous",
        referrerpolicy: "no-referrer",
      },
      d3: {
        src: "https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js",
        integrity: "sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A==",
        crossorigin: "anonymous",
        referrerpolicy: "no-referrer",
      },
    };

    const lib = libraries[library];
    if (!lib) return '';

    let scriptTag = `
      <script
        src="${lib.src}"
        integrity="${lib.integrity}"
        crossorigin="${lib.crossorigin}"
        referrerpolicy="${lib.referrerpolicy}"
      ></script>
    `;

    if (library === 'p5' || library === 'd3') {
      scriptTag += `
        <script>
          window.${library}ScriptLoaded = true;
          window.dispatchEvent(new Event('${library}Loaded'));
        </script>
      `;
    }

    return new nunjucks.runtime.SafeString(scriptTag);
  }
  ```

- **Custom Shortcodes**: Simplify embedding of sketches in Markdown files.

  ```javascript
  eleventyConfig.addShortcode("sketchContainer", function (src, id) {
    return `
      <div id="${id}" class="p5js-container"></div>
      ${loadLibrary('p5')}
      <script src="../${src}"></script>
    `;
  });

  eleventyConfig.addShortcode("d3Container", function (src, id) {
    return `
      <div id="${id}" class="d3-container"></div>
      ${loadLibrary('d3')}
      <script src="../${src}"></script>
    `;
  });

  eleventyConfig.addShortcode("threeContainer", function (src, id) {
    return `
      <div id="${id}" class="three-container"></div>
      <script type="module" src="../${src}"></script>
    `;
  });
  ```

- **Markdown Configuration**: Allows HTML in Markdown files.

  ```javascript
  const markdownItOptions = {
    html: true,
  };
  eleventyConfig.setLibrary("md", markdownIt(markdownItOptions));
  ```

- **Collections for Navigation**: Generates navigation based on entries.

  ```javascript
  eleventyConfig.addCollection("entries", function (collectionApi) {
    return collectionApi.getFilteredByGlob("src/entries/**/*.md");
  });
  ```

- **Eleventy Configuration**: Sets input and output directories.

  ```javascript
  return {
    dir: {
      input: "src",
      output: "_site",
      includes: "_includes",
      data: "_data",
    },
    markdownTemplateEngine: "njk",
  };
  ```

- **Auto-generated Front Matter**: Automatically adds essential front matter to Markdown files, if they don't already have it.

  ```javascript
  eleventyConfig.addTransform("autoFrontMatter", function(content, outputPath) {
    if (outputPath && outputPath.endsWith(".html")) {
      const frontMatter = `---
layout: ${this.layout || "layout.njk"}
title: ${this.title || "Untitled"}
date: ${this.page.date.toISOString().split('T')[0]}
---\n\n`;
      
      if (!content.trim().startsWith("---")) {
        content = frontMatter + content;
      }
    }
    return content;
  });


### tsconfig.json

This file configures TypeScript to ensure proper compilation and type checking.

#### Explanation

- **Compiler Options**:

  ```json
  {
    "compilerOptions": {
      "target": "es6",
      "strict": true,
      "module": "ESNext",
      "moduleResolution": "Node",
      "typeRoots": [
        "./node_modules/@types",
        "./src/types"
      ],
      "types": ["p5", "d3", "three"]
    },
    "include": ["src/**/*", "./src/types/globals.d.ts"],
    "exclude": ["node_modules"]
  }
  ```

  - **target**: Specifies ECMAScript target version.
  - **module**: Uses ESNext for modern module syntax.
  - **strict**: Enables strict type checking.
  - **typeRoots**: Includes custom type definitions.
  - **types**: Includes type definitions for p5.js, D3.js, and Three.js.

### globals.d.ts

Declares global types for p5.js and potentially D3.js, ensuring TypeScript recognizes global variables.

#### p5.js Global Declaration

```typescript
import p5 from 'p5';

declare global {
  var p5: typeof p5;
}

export {};
```

This setup allows you to use `p5` globally in your TypeScript files.

### main.css

Defines the layout and styling for the journal, including specific styles for sketch containers.

#### Explanation

- **Custom Variables**: Sets default font family and colors.

  ```css
  :root {
    --font-family: 'Helvetica Neue', Arial, sans-serif;
    --color: #333;
    --primary: #007bff;
  }
  ```

- **Base Styles**: Applies to the body.

  ```css
  body {
    font-family: var(--font-family);
    font-size: 0.8rem;
    line-height: 1.6;
    color: var(--color);
  }
  ```

- **Layout**: Defines the main grid layout.

  ```css
  .layout-grid {
    display: flex;
    flex-direction: row;
    min-height: 100vh;
  }

  .vertical-nav {
    width: 200px;
    padding: 1rem;
    background-color: white;
    overflow-y: auto;
  }

  .main-content {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
  }
  ```

- **Navigation Styles**: Styles the navigation links.

  ```css
  nav.vertical-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: block;
  }

  nav.vertical-nav ul li a {
    display: block;
    margin: 0;
    padding: 0.2rem 0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    color: var(--color);
    text-decoration: none;
    line-height: 1.2;
    transition: color 0.3s ease;
  }
  ```

- **Sketch Container Styles**: Ensures proper display of sketches.

  ```css
  .sketch-container,
  .d3-container,
  .three-container {
    flex: 1;
    position: relative;
    width: 100%;
    height: auto;
    overflow: hidden;
    min-height: 50vh;
  }

  .sketch-container canvas,
  .d3-container svg,
  .three-container canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
  ```

- **Responsive Adjustments**: Makes layout mobile-friendly.

  ```css
  @media (max-width: 768px) {
    .layout-grid {
      flex-direction: column;
    }

    .vertical-nav {
      width: 100%;
    }
  }
  ```

### layout.njk

The main Nunjucks layout template that provides the HTML structure for all pages.

#### Explanation

- **HTML Structure**: Sets up the basic HTML skeleton.

  ```html
  <!DOCTYPE html>
  <html lang="en">
  ```

- **Head Section**: Includes meta tags and stylesheets.

  ```html
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <link rel="stylesheet" href="/styles/main.css">
  </head>
  ```

- **Body Content**: Contains the navigation and main content.

  ```html
  <body>
    <div class="layout-grid">
      <nav class="vertical-nav">
        <ul>
          <li>
            <a href="/">Home</a>
          </li>
          {% for entry in collections.entries | reverse %}
          <li>
            <a href="{{ entry.url }}">{{ entry.data.title }}</a>
          </li>
          {% endfor %}
        </ul>
      </nav>
      <main class="main-content">
        {{ content | safe }}
      </main>
    </div>
  </body>
  ```

### threejs-shared-module.js and .d.ts

These files handle the modular loading of Three.js and provide type definitions for TypeScript.

#### threejs-shared-module.js

```javascript
import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.168.0/three.module.min.js';
export { THREE };
```

#### threejs-shared-module.d.ts

```typescript
declare module '../../scripts/threejs-shared-module.js' {
  import * as THREE from 'three';
  export { THREE };
}
```

This setup allows you to import Three.js in your sketch files using ES6 module syntax, ensuring proper TypeScript support.

## How to Use

### Creating a New Entry

1. **Create a New Folder**: In `src/entries/`, create a new folder named with the date and a title (e.g., `240820-my-new-sketch`).

2. **Add a Markdown File**: Inside the new folder, create a `sketch.md` file for your journal entry.

3. **Write Your Entry**: In `sketch.md`, write your content and use shortcodes to embed sketches.

### Embedding Sketches

Use the custom shortcodes to embed sketches within your Markdown files.

- **p5.js Sketch**:

  ```markdown
  {% sketchContainer "sketch_p5.js", "sketchId" %}
  ```

- **D3.js Sketch**:

  ```markdown
  {% d3Container "sketch_d3.js", "d3Id" %}
  ```

- **Three.js Sketch**:

  ```markdown
  {% threeContainer "sketch_three.js", "threeId" %}
  ```

### Writing p5.js Sketches in TypeScript

Create a `.ts` file (e.g., `sketch_p5.ts`) in your entry folder.

#### Example

```typescript
function sketch(p: p5) {
  p.setup = () => {
    p.createCanvas(400, 400);
  };

  p.draw = () => {
    p.background(220);
    p.ellipse(p.width / 2, p.height / 2, 50, 50);
  };
}

new p5(sketch);
```

**Note**: Ensure you have `import p5 from 'p5';` at the top if you're using modules.

### Writing D3.js Sketches

Create a `.js` file (e.g., `sketch_d3.js`) in your entry folder.

#### Example

```javascript
function createBarChart(containerId = "d3Id") {
  const data = [30, 80, 45, 60, 20, 90, 50];
  const svg = d3.select(`#${containerId}`).append("svg")
    .attr("width", 500)
    .attr("height", 300);

  svg.selectAll("rect")
    .data(data)
    .enter()
    .append("rect")
    .attr("x", (d, i) => i * 70)
    .attr("y", (d) => 300 - d)
    .attr("width", 65)
    .attr("height", (d) => d)
    .attr("fill", "teal");
}

document.addEventListener('DOMContentLoaded', () => {
  createBarChart();
});
```

### Writing Three.js Sketches

Create a `.js` file (e.g., `sketch_three.js`) in your entry folder.

#### Example

```javascript
import { THREE } from '../../scripts/threejs-shared-module.js';

function createRotatingCube(containerId = 'threeId') {
  const container = document.getElementById(containerId);
  if (!container) {
    console.error(`Container with id "${containerId}" not found.`);
    return;
  }

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  const geometry = new THREE.BoxGeometry();
  const material = new THREE.MeshNormalMaterial();
  const cube = new THREE.Mesh(geometry, material);
  scene.add(cube);

  camera.position.z = 5;

  function animate() {
    requestAnimationFrame(animate);
    cube.rotation.x += 0.01;
    cube.rotation.y += 0.01;
    renderer.render(scene, camera);
  }

  animate();
}

createRotatingCube();
```

**Note**: Use ES6 module syntax and import Three.js from the shared module.

## Build and Development

### Installing Dependencies

```bash
npm install
```

### Building the Project

```bash
npm run build
```

This script compiles TypeScript files and builds the site using Eleventy.

### Development with Live Reloading

```bash
npm run start
```

This script starts the Eleventy development server with live reloading.

### Scripts in package.json

### Scripts in `package.json`

Our `package.json` includes several scripts to streamline development and building processes:

```json
"scripts": {
  "start": "npm-run-all --parallel watch:ts eleventy:serve",
  "build": "tsc && eleventy",
  "watch:ts": "tsc --watch",
  "eleventy:serve": "eleventy --serve --watch"
}
```

To run these scripts, use `npm run <script-name>`. Here's a breakdown of each script:

#### `start`

```bash
npm run start
```

This is the main development script. It runs TypeScript compilation in watch mode and starts the Eleventy development server concurrently. Use this for active development with live reloading.

#### `build`

```bash
npm run build
```

This script compiles TypeScript files and then builds the site using Eleventy. Use this for production builds.

#### `watch:ts`

```bash
npm run watch:ts
```

This script runs TypeScript compilation in watch mode. It's useful if you want to compile TypeScript without starting the Eleventy server.

#### `eleventy:serve`

```bash
npm run eleventy:serve
```

This script starts the Eleventy development server with live reloading. It's similar to running `npx @11ty/eleventy --serve` directly.

---

For most development work, `npm run start` is recommended as it provides the full development environment with TypeScript support and live reloading.

## Troubleshooting

- **p5.js Sketches Not Loading**:

  - Ensure `globals.d.ts` correctly declares the global `p5` variable.
  - Use `p: p5` as the parameter type in your sketch function.

- **Three.js Sketches Not Displaying Correctly**:

  - Check the styles for `.three-container` in `main.css`.
  - Ensure you're importing Three.js from `threejs-shared-module.js`.

- **TypeScript Compilation Errors**:

  - Make sure your TypeScript files are included in the `tsconfig.json` `include` array.
  - Ensure all necessary type definitions are installed and included.

- **Sketch Files Not Found**:

  - Verify the paths in your shortcodes are correct.
  - Remember that the paths are relative to the output HTML file.

- **Live Reloading Not Working**:

  - Ensure you have set up watch targets in `.eleventy.js`.
  - Check that you're running `npm run start`.

## Remember

- **File Placement**: Keep sketch files in the same folder as their corresponding Markdown entry.

- **Shortcodes**: Use the appropriate shortcode for each library type.

- **TypeScript**: Always compile TypeScript files before running Eleventy.

- **Minimal Configuration**: The setup is designed to require minimal changes for normal use.

- **Focus on Content**: The goal is to focus on writing entries and creating sketches, with the setup handling the complexities of library loading and embedding.

- **Consistency**: Maintain consistent naming conventions for ease of navigation and maintenance.

## Additional Resources

- [Eleventy Documentation](https://www.11ty.dev/docs/)
- [p5.js Reference](https://p5js.org/reference/)
- [D3.js Documentation](https://d3js.org/)
- [Three.js Documentation](https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/handbook/intro.html)

---
